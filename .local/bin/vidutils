#!/bin/bash

####
# USAGE: vidutils [--help]
# USAGE: vidutils command [-x X][-y Y][-w width][-h height][-f from][-t to][-l length][-s subtitle]
# 
# COMMANDS:
# 
#     crop           -  Crop video (use -xywh options to specify the size)
#     screen-record  -  Record screen (only supports OSX)
#     cut            -  Cut a clip $FROM second (-ss) $TO second (-t)
#     cut-with-sub   -  Cut a clip from time to time and burn subtitles
#     extract-sub    -  Extract subtitle track
#     to-gif         -  Convert clip to GIF
# 
# OPTIONS:
# 
#     -x      X          X point in screen (only for crop command)
#     -y      Y          Y point in screen (only for crop command)
#     -w      width      width of cropping (only for crop command)
#     -h      height     height of cropping (only for crop command)
#     -f      from       from time
#     -t      to         to time
#     -l      length     length of clip
#     -s      subtitle   subtitle file
###

PROGNAME=`type $0 | awk '{print $3}'`
PROGDIR=`dirname $PROGNAME`
PROGNAME=`basename $PROGNAME`
usage()
{
    echo >&2 "$PROGNAME:" "$@"
    sed >&2 -e '1,/^####/d;  /^###/g;  /^#/!q;  s/^#//;  s/^ //' "$PROGDIR/$PROGNAME"
}

if [[ $# -eq 0 ]] ; then
    echo ""
    usage
    exit 0
fi

X=""
Y=""
W=""
H=""
SIZE=""
TIME=""


CMD=$1
shift

while getopts ":s:t:g:x:y:w:h:" o; do
    case "${o}" in
        x) X="${OPTARG}" ;;
        y) Y="${OPTARG}" ;;
        w) W="${OPTARG}" ;;
        h) H="${OPTARG}" ;;
        s) SIZE="${OPTARG}" ;;
        t) TIME="${OPTARG}" ;;
    esac
done
shift $((OPTIND-1))

INPUT=$1
OUTPUT=$2

while [ "$CMD" != "" ]; do
    case $CMD in
        crop)
            ffmpeg -i $INPUT -filter:v "crop=100:100:1:1" $OUTPUT
            exit 1
            ;;
        screen-record)
	    # TODO: Add linux support (avfoundation is only available on OSX)
            ffmpeg -f avfoundation -i "1" -framerate 30 "screen-recording-$(date +"%m-%d-%y").mkv"
            exit 1
            ;;
        cut)
            # Cut a clip from second (-ss) with length (-t) and output mp4
            ffmpeg -ss $TIME -t $SIZE -i $INPUT -async 1 $OUTPUT
            exit 1
            ;;
        cut-with-sub)
            # Cut a clip from time to time with burned subtitles
            ffmpeg -ss $FROM -to $TO -copyts -i $INPUT -vf subtitles=$SUBTITLE -c:a copy -ss $TIME -y $OUTPUT
            exit 1
            ;;
        extract-sub)
            # Extracts subtitle track from mkv
            ffmpeg -i $INPUT -map 0:s:0 ex-sub.srt
            exit 1
            ;;
        gif)
            # Output clip as GIF
	    GIF_SETTINGS="fps=10,scale=320:-1:flags=lanczos,split[s0][s1];[s0]palettegen[p];[s1][p]paletteuse"
            ffmpeg -ss $TIME -t $SIZE -i $INPUT -vf $GIF_SETTINGS -loop 0 $OUTPUT
            exit 1
            ;;
        -h | --help )           usage
            exit 1
            ;;
        * )                     usage
            exit 1
    esac
    shift
done
